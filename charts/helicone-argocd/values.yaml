################################################################################
#
#                            HELICONE ARGOCD
#
################################################################################

argocd:
  enabled: true
  createProject: true
  skipCRDCheck: true
  namespace: argocd
  source:
    repoURL: "https://github.com/Helicone/helicone-helm-v3.git"
    targetRevision: main
    path: charts/helicone-core
    helm:
      valueFiles:
        - values.yaml
      parameters: []

  destination:
    server: https://kubernetes.default.svc
    namespace: helicone

  syncPolicy:
    automated:
      prune: true
      selfHeal: false
      allowEmpty: false
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  revisionHistoryLimit: 3

argo-cd:
  enabled: true
  global:
    domain: argocd.helicone.ai

  crds:
    install: true
    keep: true

  # Service account configurations for pod identity
  controller:
    serviceAccount:
      create: true
      annotations:
        aws.amazon.com/pod-identity: "enabled"

  repoServer:
    serviceAccount:
      create: true
      annotations:
        aws.amazon.com/pod-identity: "enabled"

  applicationSet:
    serviceAccount:
      create: true
      annotations:
        aws.amazon.com/pod-identity: "enabled"

  # Server configuration
  server:
    serviceAccount:
      create: true
      annotations:
        aws.amazon.com/pod-identity: "enabled"
    service:
      type: ClusterIP
      servicePortHttp: 80
    ingress:
      enabled: true
      ingressClassName: nginx
      hosts:
        - argocd.helicone.ai
      tls:
        - secretName: argocd-tls
          hosts:
            - argocd.helicone.ai
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
        nginx.ingress.kubernetes.io/server-snippet: |
          grpc_read_timeout 300;
          grpc_send_timeout 300;

  # Disable Dex for simplicity (use built-in admin user)
  dex:
    enabled: false

  # Configs
  configs:
    params:
      server.insecure: true # TODO Set this to false in production
    
    # RBAC Configuration
    rbac:
      policy.default: role:readonly
      policy.csv: |
        # Built-in admin user
        p, role:admin, applications, *, */*, allow
        p, role:admin, clusters, *, *, allow
        p, role:admin, repositories, *, *, allow
        p, role:admin, projects, *, *, allow
        p, role:admin, accounts, *, *, allow
        p, role:admin, certificates, *, *, allow
        p, role:admin, gpgkeys, *, *, allow
        p, role:admin, logs, get, *, allow
        p, role:admin, exec, create, */*, allow
        
        # Default readonly role
        p, role:readonly, applications, get, */*, allow
        p, role:readonly, repositories, get, *, allow
        p, role:readonly, clusters, get, *, allow
        p, role:readonly, projects, get, *, allow
        
        # Group mappings (for future SSO integration)
        g, helicone:admin, role:admin
        g, helicone:developer, role:readonly
        
        # Default admin user gets admin role
        g, admin, role:admin
    